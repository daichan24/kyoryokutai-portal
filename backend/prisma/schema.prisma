generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String
  role     Role   @default(MEMBER)

  // 協力隊属性
  missionType MissionType?
  department  String?
  termStart   DateTime?
  termEnd     DateTime?

  // カスタマイズ
  avatarColor String @default("#3B82F6")

  // Phase 1 Relations
  schedules     Schedule[]
  weeklyReports WeeklyReport[]

  // Phase 2 Relations
  missions            Mission[]
  projects            Project[]
  projectMemberships  ProjectMember[]
  projectTasks        ProjectTask[]        @relation("TaskAssignee")
  events              Event[]
  eventParticipations EventParticipation[]
  snsPosts            SNSPost[]
  monthlyReports      MonthlyReport[]      @relation("MonthlyReportCreator")
  supportRecords      SupportRecord[]
  contacts            Contact[]
  contactHistories    ContactHistory[]

  // Phase 3 Relations
  scheduleSuggestions ScheduleSuggestion[]

  // Phase 4 Relations
  requestsSent         Request[]             @relation("Requester")
  requestsReceived     Request[]             @relation("Requestee")
  inspections          Inspection[]
  personalModeEnabled  Boolean               @default(false)
  personalProjects     PersonalProject[]
  personalSchedules    PersonalSchedule[]
  notifications        Notification[]
  scheduleParticipants ScheduleParticipant[]

  // ダッシュボード設定（JSON）
  dashboardConfigJson Json?

  // SNSリンク（JSON配列: [{ platform: "instagram", url: "..." }, ...]）
  snsLinks Json?

  // 協力隊催促関連
  nudgeDocumentsUpdated NudgeDocument[] @relation("NudgeUpdater")
  nudgeRevisions        NudgeRevision[] @relation("NudgeRevisionUpdater")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  MASTER
  MEMBER
  SUPPORT
  GOVERNMENT
}

enum MissionType {
  FREE
  MISSION
}

// ========================================
// スケジュール（Phase 2拡張）
// ========================================

model Schedule {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date      DateTime @db.Date
  startTime String
  endTime   String

  locationId   String?
  location     Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  locationText String?

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  activityDescription String   @db.Text
  participants        String[] // User IDの配列（後方互換性のため残す）
  freeNote            String?  @db.Text

  isTemplate      Boolean @default(false)
  recurrenceRule  Json? // { type: 'daily|weekly|monthly', interval: 1, endDate: Date }
  isPending       Boolean @default(false)
  isAutoExtracted Boolean @default(false) // 月次報告自動抽出フラグ

  createdBy CreatedBy @default(MANUAL)

  scheduleProgress     ScheduleProgress[]
  suggestions          ScheduleSuggestion[]
  scheduleParticipants ScheduleParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([projectId])
  @@index([locationId])
}

enum CreatedBy {
  MANUAL
  TEMPLATE
  RECURRENCE
}

model Location {
  id       String  @id @default(uuid())
  name     String
  order    Int     @default(0)
  isActive Boolean @default(true)

  schedules Schedule[]
  events    Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WeeklyReport {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  week   String

  thisWeekActivities Json
  nextWeekPlan       String? @db.Text
  note               String? @db.Text

  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, week])
}

// ========================================
// ミッション管理（旧：起業準備進捗管理）
// ========================================

model Mission {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  missionName      String
  missionType      MissionTypeEnum @default(PRIMARY)
  targetPercentage Int             @default(100)

  approvalStatus  ApprovalStatus @default(DRAFT)
  approvalComment String?        @db.Text
  approvedBy      String?
  approvedAt      DateTime?

  midGoals MidGoal[]
  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model MidGoal {
  id        String  @id @default(uuid())
  missionId String
  mission   Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  name         String
  weight       Int
  weightMethod WeightMethod @default(MANUAL)
  startDate    DateTime?    @db.Date
  endDate      DateTime?    @db.Date
  order        Int          @default(0)

  subGoals SubGoal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([missionId])
}

model SubGoal {
  id        String  @id @default(uuid())
  midGoalId String
  midGoal   MidGoal @relation(fields: [midGoalId], references: [id], onDelete: Cascade)

  name         String
  weight       Int
  weightMethod WeightMethod @default(MANUAL)
  startDate    DateTime?    @db.Date
  endDate      DateTime?    @db.Date
  order        Int          @default(0)

  tasks GoalTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([midGoalId])
}

model GoalTask {
  id        String  @id @default(uuid())
  subGoalId String
  subGoal   SubGoal @relation(fields: [subGoalId], references: [id], onDelete: Cascade)

  name      String
  weight    Int
  progress  Int       @default(0)
  phase     Phase     @default(PREPARATION)
  startDate DateTime? @db.Date
  endDate   DateTime? @db.Date
  order     Int       @default(0)

  scheduleProgress ScheduleProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subGoalId])
}

enum MissionTypeEnum {
  PRIMARY
  SUB
}

enum WeightMethod {
  EQUAL
  PERIOD
  MANUAL
}

enum Phase {
  PREPARATION
  EXECUTION
  COMPLETED
  REVIEW
}

enum ApprovalStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

// ========================================
// プロジェクト管理
// ========================================

model Project {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectName String
  description String?   @db.Text
  startDate   DateTime? @db.Date
  endDate     DateTime? @db.Date
  phase       Phase     @default(PREPARATION)

  missionId String?
  mission   Mission? @relation(fields: [missionId], references: [id], onDelete: SetNull)

  approvalStatus  ApprovalStatus @default(DRAFT)
  approvalComment String?        @db.Text
  approvedBy      String?
  approvedAt      DateTime?

  tags String[]

  members          ProjectMember[]
  tasks            ProjectTask[]
  projectTasks     Task[] // プロジェクト配下のタスク（小目標）
  schedules        Schedule[]
  events           Event[]
  contactHistories ContactHistory[]
  requests         Request[] // Phase 4: 依頼（旧：タスク依頼）
  inspections      Inspection[] // Phase 4

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([missionId])
}

model ProjectMember {
  id        String     @id @default(uuid())
  projectId String
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      MemberRole @default(SUPPORT)

  createdAt DateTime @default(now())

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model ProjectTask {
  id        String  @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  taskName   String
  progress   Int       @default(0)
  assignedTo String?
  assignee   User?     @relation("TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  deadline   DateTime? @db.Date
  order      Int       @default(0)

  scheduleProgress ScheduleProgress[]
  request          Request? // Phase 4: 依頼との紐付け（旧：タスク依頼）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([assignedTo])
}

// ========================================
// タスク（ミッション配下、プロジェクトは任意）
// ========================================

model Task {
  id        String  @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title       String
  description String?    @db.Text
  status      TaskStatus @default(NOT_STARTED)
  order       Int        @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([projectId, status])
}

enum TaskStatus {
  NOT_STARTED // 未着手
  IN_PROGRESS // 進行中
  COMPLETED // 完了
}

enum MemberRole {
  LEAD
  SUPPORT
}

model ScheduleProgress {
  id         String   @id @default(uuid())
  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  goalTaskId String?
  goalTask   GoalTask? @relation(fields: [goalTaskId], references: [id], onDelete: Cascade)

  projectTaskId String?
  projectTask   ProjectTask? @relation(fields: [projectTaskId], references: [id], onDelete: Cascade)

  progressBefore Int
  progressAfter  Int

  createdAt DateTime @default(now())

  @@index([scheduleId])
  @@index([goalTaskId])
  @@index([projectTaskId])
}

// ========================================
// スケジュール参加者（共同作業）
// ========================================

model ScheduleParticipant {
  id          String            @id @default(uuid())
  scheduleId  String
  userId      String
  status      ParticipantStatus @default(PENDING)
  respondedAt DateTime?
  schedule    Schedule          @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scheduleId, userId])
  @@index([scheduleId])
  @@index([userId, status])
}

enum ParticipantStatus {
  PENDING
  APPROVED
  REJECTED
}

// ========================================
// イベント管理
// ========================================

model Event {
  id        String    @id @default(uuid())
  eventName String
  eventType EventType @default(OTHER)
  date      DateTime  @db.Date
  startTime String?
  endTime   String?

  locationId   String?
  location     Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  locationText String?
  description  String?   @db.Text

  participationPoint Float @default(1.0)
  preparationPoint   Float @default(0.5)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  surveyEnabled   Boolean @default(false)
  surveyQuestions Json?

  createdBy String
  creator   User   @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  participations EventParticipation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventType, date])
  @@index([createdBy])
  @@index([locationId])
  @@index([projectId])
}

model EventParticipation {
  id      String @id @default(uuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  participationType ParticipationType @default(PARTICIPATION)
  pointEarned       Float             @default(0)
  surveyResponse    Json?

  createdAt DateTime @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

enum EventType {
  TOWN_OFFICIAL
  TEAM
  OTHER
}

enum ParticipationType {
  PARTICIPATION
  PREPARATION
  DEPARTMENT_DUTY
}

// ========================================
// SNS投稿管理
// ========================================

model SNSPost {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 週のキー（YYYY-WW形式、月曜9:00 JST基準で週を判定）
  week String

  // 投稿日時（必須。週次判定と履歴表示に使用）
  postedAt DateTime @db.Timestamptz

  // 投稿種別（STORY/FEED、BOTHは廃止予定）
  postType PostType

  // 以下は任意入力（分析/ブランディング用）
  url           String? // 投稿リンク
  theme         String? @db.VarChar(200) // 投稿テーマ（タイトル）
  followerDelta Int? // フォロワー増減数
  views         Int? // 閲覧数（Instagramのリーチ等）
  likes         Int? // いいね数
  note          String? @db.Text // 備考

  // 後方互換性のため残す（削除予定）
  postDate DateTime? @db.Date
  isPosted Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, week], name: "userId_week")
  @@index([userId, week])
  @@index([userId, postedAt])
}

enum PostType {
  STORY
  FEED
  BOTH
}

// ========================================
// 月次報告
// ========================================

model MonthlyReport {
  id        String @id @default(uuid())
  month     String
  createdBy String
  creator   User   @relation("MonthlyReportCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  coverRecipient String @default("長沼町長 斎藤良彦様")
  coverSender    String @default("一般社団法人まおいのはこ 代表理事 坂本一志")

  memberSheets Json

  submittedAt DateTime?

  supportRecords SupportRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month])
}

model SupportRecord {
  id              String        @id @default(uuid())
  monthlyReportId String
  monthlyReport   MonthlyReport @relation(fields: [monthlyReportId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  supportDate    DateTime @db.Date
  supportContent String   @db.Text
  supportBy      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([monthlyReportId])
  @@index([userId])
}

// ========================================
// 町民データベース
// ========================================

model Contact {
  id           String   @id @default(uuid())
  name         String
  organization String?
  title        String?
  contactInfo  String?
  memo         String?  @db.Text
  tags         String[]

  // 協力隊メンバー情報（新規追加）
  role      String? // '現役' | 'OB' | 'サポート' | '役場'
  startYear Int? // 任期開始年
  endYear   Int? // 任期終了年

  // 新規追加フィールド
  category         String? // ジャンル
  relatedMembers   String[] // 関わった協力隊（User IDの配列）
  relationshipType String? // 関わり方: '協力的' | '要注意' | '未知' | '未登録'

  createdBy String
  creator   User   @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  histories ContactHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdBy])
  @@index([category])
  @@index([relationshipType])
}

model ContactHistory {
  id        String  @id @default(uuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date    DateTime @db.Date
  content String   @db.Text

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([contactId])
  @@index([userId])
  @@index([projectId])
}

// ========================================
// スケジュール提案（Phase 3）
// ========================================

model ScheduleSuggestion {
  id          String   @id @default(uuid())
  scheduleId  String
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  suggestedTo String
  user        User     @relation(fields: [suggestedTo], references: [id], onDelete: Cascade)

  status               SuggestionStatus @default(PENDING)
  conflictingSchedules Json? // 衝突する予定のID配列

  createdAt   DateTime  @default(now())
  respondedAt DateTime?

  @@unique([scheduleId, suggestedTo])
  @@index([suggestedTo, status])
  @@index([scheduleId])
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  DECLINED
  IGNORED
}

// ========================================
// システム設定
// ========================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

// ========================================
// 依頼（Phase 4、旧：タスク依頼）
// ========================================

model Request {
  id          String @id @default(uuid())
  requestedBy String
  requester   User   @relation("Requester", fields: [requestedBy], references: [id], onDelete: Cascade)
  requestedTo String
  requestee   User   @relation("Requestee", fields: [requestedTo], references: [id], onDelete: Cascade)

  requestTitle       String
  requestDescription String    @db.Text
  deadline           DateTime? @db.Date

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  approvalStatus ApprovalStatus @default(PENDING)
  approvalNote   String?        @db.Text
  approvedAt     DateTime?

  createdTaskId String?      @unique
  createdTask   ProjectTask? @relation(fields: [createdTaskId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestedBy])
  @@index([requestedTo])
  @@index([approvalStatus])
}

// ========================================
// 視察復命書（Phase 4）
// ========================================

model Inspection {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date         DateTime @db.Date
  destination  String
  purpose      String   @db.Text
  participants String[]

  inspectionPurpose String @db.Text
  inspectionContent String @db.Text
  reflection        String @db.Text
  futureAction      String @db.Text

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([date])
}

// ========================================
// 個人事業モード（Phase 4）
// ========================================

model PersonalProject {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectName String
  description String?   @db.Text
  startDate   DateTime? @db.Date
  endDate     DateTime? @db.Date
  phase       Phase     @default(PREPARATION)

  tasks     PersonalTask[]
  schedules PersonalSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model PersonalTask {
  id        String          @id @default(uuid())
  projectId String
  project   PersonalProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  taskName String
  progress Int       @default(0)
  deadline DateTime? @db.Date
  order    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

model PersonalSchedule {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date      DateTime @db.Date
  startTime String
  endTime   String

  projectId String?
  project   PersonalProject? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  activityDescription String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
}

// ========================================
// 通知システム（Phase 4）
// ========================================

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String           @db.Text
  link    String?

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  SCHEDULE_SUGGESTION
  TASK_REQUEST
  PROJECT_APPROVED
  PROJECT_REJECTED
  WEEKLY_REMINDER
  SNS_REMINDER
  PENDING_SCHEDULE
  EVENT_REMINDER
  SCHEDULE_INVITE
  SCHEDULE_INVITE_APPROVED
  SCHEDULE_INVITE_REJECTED
}

// ========================================
// 協力隊催促（Nudge）
// ========================================

model NudgeDocument {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  publishedAt DateTime
  updatedAt   DateTime @updatedAt
  updatedBy   String
  updater     User     @relation("NudgeUpdater", fields: [updatedBy], references: [id], onDelete: Cascade)

  revisions NudgeRevision[]

  createdAt DateTime @default(now())
}

model NudgeRevision {
  id         String        @id @default(uuid())
  documentId String
  document   NudgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content    String        @db.Text
  updatedBy  String
  updater    User          @relation("NudgeRevisionUpdater", fields: [updatedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([createdAt])
}
